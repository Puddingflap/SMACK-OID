<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Smackoid</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.min.js"></script>
  <style>
    html,body{margin:0;height:100%;background:#070b14;color:#e8f0ff;font-family:system-ui,Segoe UI,Inter,Arial,sans-serif}
    #gameCanvas{position:relative;width:100vw;height:100vh}
    .hud{position:fixed; top:12px; left:12px; background:rgba(10,14,24,.7); border:1px solid rgba(255,255,255,.1); border-radius:12px; padding:10px 14px; backdrop-filter: blur(6px)}
    .hud h3{margin:0 0 6px 0; font-size:14px; color:#cfe6ff}
    .row{display:flex;gap:18px;align-items:center}
    .label{font-size:13px;color:#c7d3ee}
    .value{font-weight:800}
    .muted{color:#90a0c0; font-size:12px}
    .centerNote{position:fixed; left:50%; top:50%; transform:translate(-50%,-50%);
      padding:10px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.1);
      background:rgba(10,14,24,.65); color:#e8f0ff; font-weight:700; display:none}
  </style>
</head>
<body>
  <div id="gameCanvas"></div>
  <div class="hud">
    <h3>Smackoid</h3>
    <div class="row">
      <div class="label">Mcap $:</div><div id="mcap" class="value">0 B</div>
      <div class="label">Distance:</div><div id="dist" class="value">0 m</div>
      <div class="label">Best:</div><div id="best" class="value">0 m</div>
    </div>
    <div class="muted">PC: Hold <b>SPACE</b> to charge power. <b>Release</b> to hit.<br>Mobile: Hold <b>your finger</b> on the screen and release to hit.</div>
  </div>
  <img id="sprite" src="assets/cz-droid.png" alt="" style="display:none" />
  <div id="centerMsg" class="centerNote"></div>

<script>
let asteroidImg=null, p5Ready=false;
let htmlImg=null, htmlReady=false;

const GROUND_Y=520;
const GRAVITY=0.55;
const DRAG_COEFF=0.0012;
const WIND_BASE=0.0006;
let wind=0;

const LAUNCH_FRAMES = 36;
const LAUNCH_GRAVITY_SCALE = 0.8;
const LAUNCH_DRAG_SCALE    = 0.45;

const BATTER_X = Math.floor(window.innerWidth * 0.16);
const HIT_OFFSET = 90;
const SWEET_CENTER_Y = GROUND_Y - 90;
const SWEET_HALF = 34;

let camX = 0;
const CAM_LEAD = 0.35;
const CAM_EASE = 0.08;
let camShake = 0, camShakeT = 0;

let phase='drop';
let asteroid={ x: BATTER_X + HIT_OFFSET, y:-150, vx:0, vy:0, r:70 };

let batter={ x: BATTER_X, y: GROUND_Y-20, swingT:0, swinging:false };
const SWING_START = -Math.PI*0.60, SWING_IMPACT_T=0.35, SWING_END = -Math.PI*0.15;
function armAngle(){ return lerp(SWING_START, SWING_END, batter.swinging ? constrain(batter.swingT,0,1) : 0); }

let distance=0, bestDistance=0, mcap=0;

let charging=false, charge=0, chargeDir=1;
const CHARGE_SPEED = 0.028;

let pendingHit=false, plannedV=null, locked=false;
let flightFrames=0;

const centerMsgEl = document.getElementById('centerMsg');
const showCenter = (msg)=>{ centerMsgEl.textContent=msg; centerMsgEl.style.display='block'; };
const hideCenter = ()=>{ centerMsgEl.style.display='none'; };

function setup(){
  const cnv=createCanvas(960,600); cnv.parent('gameCanvas');
  imageMode(CENTER); textFont('system-ui');

  loadImage('assets/cz-droid.png', img => { asteroidImg=img; p5Ready=true; });
  htmlImg = document.getElementById('sprite');
  if (htmlImg.complete && htmlImg.naturalWidth>0) htmlReady = true;
  htmlImg.addEventListener('load', ()=>{ htmlReady=true; });

  resetRound(false);

  // --- Keyboard
  addEventListener('keydown', e => {
    if(e.code==='Space'){ e.preventDefault(); handlePress(); }
  }, {passive:false});
  addEventListener('keyup', e => {
    if(e.code==='Space'){ e.preventDefault(); handleRelease(); }
  }, {passive:false});

  // --- Touch
  addEventListener('touchstart', e => { e.preventDefault(); handlePress(); }, {passive:false});
  addEventListener('touchend', e => { e.preventDefault(); handleRelease(); }, {passive:false});
}

function handlePress(){
  if (phase==='end'){ resetRound(true); return; }
  if (!locked && !charging && (phase==='drop' || phase==='charge')){
    charging=true; phase='charge';
  }
}
function handleRelease(){
  if (phase==='end'){ resetRound(true); return; }
  if (!locked && charging){
    charging=false; locked=true;
    decideImpact();
    phase='swing'; batter.swinging=true; batter.swingT=0;
  }
}

function draw(){
  clear();

  let shakeX=0;
  if (camShake > 0){
    camShakeT += 0.3;
    shakeX = Math.sin(camShakeT*12) * camShake;
    camShake *= 0.9;
    if (camShake < 0.1) camShake = 0;
  }

  if (phase==='flight' || phase==='swing'){
    const target = asteroid.x - width*CAM_LEAD;
    camX += (target - camX) * CAM_EASE;
  } else {
    camX += (0 - camX) * CAM_EASE;
  }

  drawHorizon(shakeX);
  drawBatter(shakeX);

  byId('mcap').textContent = `${mcap.toFixed(1)} B`;
  byId('dist').textContent = `${Math.floor(distance)} m`;
  byId('best').textContent = `${Math.floor(bestDistance)} m`;

  if ((phase==='drop' || phase==='charge') && charging){
    phase='charge';
    charge += CHARGE_SPEED * chargeDir;
    if (charge>=1){ charge=1; chargeDir=-1; }
    if (charge<=0){ charge=0; chargeDir=1; }
  }

  if(phase==='drop' || phase==='charge'){
    asteroid.y += 8; // faster falling speed
    if (asteroid.y >= GROUND_Y - asteroid.r){
      asteroid.y = GROUND_Y - asteroid.r;
      phase='end'; showCenter('Restart? Press SPACE or Tap'); bestDistance=Math.max(bestDistance,distance);
    }
    drawAsteroid(shakeX);
  }
  else if(phase==='swing'){
    if (pendingHit && batter.swingT >= SWING_IMPACT_T){
      asteroid.vx = plannedV.vx; asteroid.vy = plannedV.vy;
      pendingHit=false; plannedV=null;
      flightFrames=0;
      camShake = 6; camShakeT = 0;
    }
    drawAsteroid(shakeX);
    batter.swingT += 0.20;
    if (batter.swingT >= 1){
      batter.swingT=0; batter.swinging=false;
      phase = (Math.abs(asteroid.vx)+Math.abs(asteroid.vy) > 0.001) ? 'flight' : 'drop';
    }
  }
  else if(phase==='flight'){
    const launchPhase = flightFrames < LAUNCH_FRAMES;
    const g = launchPhase ? GRAVITY * LAUNCH_GRAVITY_SCALE : GRAVITY;
    const dragCoeff = launchPhase ? DRAG_COEFF * LAUNCH_DRAG_SCALE : DRAG_COEFF;

    const v = Math.hypot(asteroid.vx, asteroid.vy);
    const drag = dragCoeff * v;
    asteroid.vx -= drag * asteroid.vx;
    asteroid.vy -= drag * asteroid.vy;

    asteroid.vx += wind;
    asteroid.vy += g;

    asteroid.x += asteroid.vx;
    asteroid.y += asteroid.vy;

    drawAsteroid(shakeX);

    distance = Math.max(distance, asteroid.x - (BATTER_X + HIT_OFFSET));
    mcap = Math.max(0, distance/25);

    if(asteroid.y >= GROUND_Y - asteroid.r){
      asteroid.y = GROUND_Y - asteroid.r;
      phase='end'; showCenter('Restart? Press SPACE or Tap'); bestDistance=Math.max(bestDistance,distance);
    }

    flightFrames++;
  }
  else if(phase==='end'){
    drawAsteroid(shakeX);
  }

  drawPowerMeter();
}

function decideImpact(){
  const dy = asteroid.y - SWEET_CENTER_Y;
  const within = Math.abs(dy) <= SWEET_HALF;
  if (!within){ pendingHit=false; plannedV=null; return; }

  const q = 1 - Math.min(1, Math.abs(dy)/SWEET_HALF);
  const curved = Math.pow(charge, 1.2);

  let baseStrength = 18 + curved*(42-18);
  baseStrength *= (0.75 + 0.40*q);
  if (Math.abs(dy) <= SWEET_HALF*0.20) baseStrength *= 1.35;

  const angle = radians(26 + 36*q);
  plannedV = { vx: Math.cos(angle)*baseStrength, vy: -Math.sin(angle)*baseStrength };
  pendingHit = true;

  if (Math.random() < 0.5) wind = (Math.random()*2-1) * WIND_BASE;
}

function resetRound(newWind=true){
  hideCenter();
  phase='drop';
  asteroid.x = BATTER_X + HIT_OFFSET;
  asteroid.y = -150;
  asteroid.vx = asteroid.vy = 0;
  distance = 0; mcap = 0;
  wind = newWind ? (Math.random()*2-1) * WIND_BASE : 0;
  charge = 0; chargeDir = 1; charging = false;
  pendingHit=false; plannedV=null; locked=false;
  camX = 0; camShake=0; camShakeT=0;
  flightFrames=0;
}

function drawAsteroid(shakeX=0){
  const sx = (asteroid.x - camX) + shakeX;
  if(p5Ready && asteroidImg){
    image(asteroidImg, sx, asteroid.y, asteroid.r*2, asteroid.r*2);
  } else if (htmlReady && htmlImg){
    const ctx = drawingContext;
    ctx.save(); ctx.imageSmoothingEnabled = true;
    ctx.drawImage(htmlImg, sx - asteroid.r, asteroid.y - asteroid.r, asteroid.r*2, asteroid.r*2);
    ctx.restore();
  } else {
    noStroke(); fill(180); circle(sx, asteroid.y, asteroid.r*2);
  }
}

function drawHorizon(shakeX=0){
  const start = -100000 - camX + shakeX;
  const w = 200000 + width;
  noStroke(); fill(20,30,50);
  rect(start, GROUND_Y, w, height-GROUND_Y);
  stroke(80,120,200,120);
  line(start, GROUND_Y, start+w, GROUND_Y);
}

function drawPowerMeter(){
  const w=260,h=14,x=width-w-20,y=20;
  noFill(); stroke(255,80); rect(x,y,w,h,8);
  const p = (phase==='charge' && (charge>0 || charging)) ? charge : 0;
  noStroke(); fill(110,231,255,180);
  rect(x+2,y+2,(w-4)*p,h-4,6);
  fill(200); textSize(12); textAlign(LEFT,TOP); text('Power',x,y+h+4);
}

function drawBatter(shakeX=0){
  const sx = (batter.x - camX) + shakeX;
  if (sx < -60 || sx > width+60) return;
  push(); translate(sx,batter.y);
  stroke(220); strokeWeight(4);
  line(0,0,-10,20); line(0,0,10,20);
  line(0,-20,0,0);
  noStroke(); fill(240); circle(0,-28,14);
  stroke(220); strokeWeight(4);
  const a = armAngle();
  const handX = 0 + Math.cos(a)*22, handY = -12 + Math.sin(a)*22;
  line(0,-12, handX, handY);
  line(0,-12, -16, -6);
  stroke(255,210,120); strokeWeight(6);
  line(handX, handY, handX + Math.cos(a)*26, handY + Math.sin(a)*26);
  pop();
}

function byId(id){ return document.getElementById(id); }
</script>
</body>
</html>
